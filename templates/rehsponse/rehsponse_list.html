{% extends "base.html" %}
{% load static %}
{% block title %} {{block.super}} | Home {% endblock %}
{% block content %}
    <div class="row pt-3" data-pg-collapsed>
        <div class="col-md-2 text-center shadow pt-3" data-pg-collapsed>
            <a href="{% url 'userdetail' username=request.user.first_name %}">
                <img class="w-200 img-thumbnail rounded-circle mx-auto shadow-sm" src="{% static 'assets/img/user-profile-svgrepo-com.svg' %}" width="140" height="140" alt="{{ request.user.first_name}}_photo">
            </a>
            <h5 class="font-weight-bold pt-3" >{{request.user.first_name}} {{ request.user.last_name }}</h5>
            <h6><small>Joined: {{request.user.created_on}}</small></h6>
        </div>
        <div class="col-md-8 pb-4">
            {% if not request.GET.q %}
            {% include "rehsponse/forms/create_rehsponse_form.html" with form=create_form action_url=create_url btn_title="Rehsponse" form_id="res-form"%}
            <hr/>
            {% endif %}
            <div id="response-container">

            </div>
            <div class="row pr-2 ">
                <div class="col-md-12 col-xl-12 text-center">
                    <a href="#" id="load-more" ><span class="font-weight-bold">Load More</span></a>
                </div>
            </div>

    </div>
        <div class="col-md-2 shadow pt-3">
        <h5 class="font-weight-bold">Latest Tags</h5>
        <hr/>
            <div id="tag-container">
            </div>

    </div>


    </div>
{% endblock %}

{% block script %}
    <script>
    // get query from url
    function getParameterByName(name, url) {
        if (!url) {
            url = window.location.href;
        }
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
    }

    $(document).ready(function(){
        // global variables
        let query = getParameterByName('q');
        let responseCollection = $("#response-container");
        let responseList = [];
        let resCreateForm = $("#res-form");
        let charsStart = 140;
        let charsCurrent = 0;
        resCreateForm.append("<h7><small class=\"font-weight-bold\" id='resCharsLeft'>" + charsStart + "</small></h7><small> characters left</small>");
        let nextResponseURL;
        let spanChars = $("#resCharsLeft");

        // functions
        // attach a response on html dom
        function attachResponse(responseData, prepend){
            let reContent = responseData.rehsponse_text;
            let reTimesince = responseData.timesince;
            let reDateDisplay = responseData.date_display;
            let reUser = responseData.user_profile.first_name;
            let reUserUrl = responseData.user_profile.user_url;
            let reUrl = responseData.own_url;
            let responseTag =
                `<div class="row pr-2">
                <div class="col-md-2 text-right col-xl-2 text-sm-center">
                <img src="{% static 'assets/img/user-profile-svgrepo-com.svg' %}"  class=" img-thumbnail rounded-circle" alt="user_photo" width="56" height="56"/>
                </div>
                <div class="col-md-10">
                    <div class="row">
                        <div class="col-xl-6 text-left text-sm-center text-lg-left col-lg-6">
                            <span><a href="${reUserUrl}">@${reUser}</a></span>
                        </div>
                        <div class="col-xl-6 text-right text-sm-center col-lg-6 text-lg-right">
                            <small>at ${reDateDisplay} (${reTimesince})</small>
                        </div>
                    </div>
                    <div class="row">
                        <span class="media-body">${reContent}</span>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mt-auto mb-auto pt-xl-auto mb-xl-auto text-sm-center col-lg-6 text-lg-left">
                            <small><i class="fas fa-bullhorn"></i> 9 responses | <i class="fas fa-heart"></i> 11 loves </small>
                        </div>
                        <div class="btn-group btn-group-sm col-md-6 col-xl-6" role="group" aria-label="Basic example">
                            <button type="button" class="btn btn-secondary">
                                <i class="fas fa-bullhorn"></i> Rehspond
                            </button>
                            <button type="button" class="btn btn-secondary">
                                <i class="fas fa-heart"></i> Love
                            </button>
                            <button type="button" class="btn btn-secondary">
                                <i class="fas fa-pencil-alt"></i> Edit
                            </button>
                         </div>
                    </div>
                    <hr/>
                </div>
            </div>`;
        if (prepend === true) {
            responseCollection.prepend(responseTag);
        }
        else {
            responseCollection.append(responseTag)
        }
    }

        // append or prepend a response
        function parseResponse(listOfResponse){
        if (listOfResponse.length === 0) {
            responseCollection.append("<p>Nothing Found</p>")
        } else {
            $.each(listOfResponse, function (key, val) {
                attachResponse(val, false)
            })
        }
    }

        // api fetch list
        function getResponse(query, listOfResponse, url) {
            let fetchURL;
            if (!url) {
                fetchURL = '/api/list/'
            } else {
                fetchURL = nextResponseURL
            }
            $.ajax({
                url: fetchURL,
                method: 'GET',
                data: {'q': query},
                success: function (data) {
                    listOfResponse = data.results;
                    if (data.next){
                        nextResponseURL = data.next;
                    } else {
                        $('#load-more').css('display', 'none');
                    }
                    parseResponse(listOfResponse);
                    updateHashLink();
                },
                error: function (data) {
                    console.log(data);
                }
            });
        }

        // api create
        function createResponse(formData, thisForm){
        $.ajax({
            url: '/api/rehsponse/create/',
            method: 'POST',
            data: formData,
            success: function (data) {
                thisForm.find("input[type=text], textarea").val("");
                attachResponse(data, true);
                spanChars.text(charsStart);
                updateHashLink();
            },
            error: function (data) {
                console.log(data);
            }
        });
    }
        
        // hash tag
        function updateHashLink() {
            $(".media-body").each(function(data){
                let hashTagRegex = /(^|\s)#([\w\d-]+)/g;
                let newText = $(this).html().replace(hashTagRegex, "$1<a href='/tags/$2'>#$2</a>");
                $(this).html(newText);
            })
        }

        // fetch hash tag from api
        function getHashTag() {
            $.ajax({
                url: '/api/hashtag/',
                method: 'GET',
                success: function(data){
                    $.each(data , function(key, val){
                        let tagTitle = val.tag;
                        let tagUrl = val.tag_url;
                        let tagTemplate = `<a href="${tagUrl}"><span>#${tagTitle}</span><br/></a>`;
                        $('#tag-container').append(tagTemplate);
                    });

                },
                error:function(e){
                    console.log(e);
                }
            })
        }

        getResponse(query,responseList);

        getHashTag();

        $('#load-more').bind('click', function (event) {
            event.preventDefault();
            if (nextResponseURL) {
                getResponse(query, responseList, nextResponseURL);
            } else {
                console.log("No more response");
            }

        });

        resCreateForm.submit(function(event){
            event.preventDefault();
            let this_ = $(this);
            let formData = this_.serialize();
            if (charsCurrent >= 0) {
                createResponse(formData, this_);
            } else {
                console.log("Exceeds response length");
            }
        });

        $("#res-form textarea").keyup(function (event) {
            let resValue = $(this).val();
            charsCurrent = charsStart - resValue.length;
            spanChars.text(charsCurrent);
            if (charsCurrent > 0) {
                // remove classes
                spanChars.removeClass("grey-color");
                spanChars.removeClass("red-color");
            } else if (charsCurrent === 0) {
                // grey class
                spanChars.removeClass("red-color");
                spanChars.addClass("grey-color");
            } else if (charsCurrent < 0) {
                // red class
                spanChars.removeClass('grey-color');
                spanChars.addClass('red-color');
                // submit button disabled
            }

        })
    })
    </script>
{% endblock %}